<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Master Portal | SSIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = { theme: { extend: { colors: { 'ssia-green': '#006633', 'ssia-gold': '#FFD700', 'ssia-light': '#f0fdf4' }, fontFamily: { sans: ['Inter', 'sans-serif'] } } } }
    </script>
</head>
<body class="font-sans text-gray-800 bg-gray-100 min-h-screen relative flex flex-col">

    <div id="customModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[100] backdrop-blur-sm transition-opacity">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full transform scale-100 transition-transform">
            <div class="text-center mb-4">
                <div id="modalIconBg" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl transition-colors">
                    <i id="modalIcon" class="fas fa-question"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Confirm Action</h3>
                <p class="text-sm text-gray-500 mt-2" id="modalText">Are you sure?</p>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50 font-semibold transition">Cancel</button>
                <button id="confirmBtn" class="flex-1 px-4 py-2 text-white rounded-lg font-bold shadow-md transition transform active:scale-95">Confirm</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-5 right-5 bg-white border-l-4 border-ssia-green shadow-2xl p-4 rounded-r flex items-center gap-4 transform translate-x-[150%] transition-transform duration-300 z-[100] min-w-[300px]">
        <div id="toastIconBg" class="bg-green-100 p-2 rounded-full text-green-600"><i id="toastIcon" class="fas fa-check"></i></div>
        <div>
            <h4 class="font-bold text-sm text-gray-800" id="toastTitle">Success</h4>
            <p class="text-xs text-gray-500" id="toastMsg">Action completed.</p>
        </div>
    </div>

    <nav class="bg-white shadow-md sticky top-0 z-50 print:hidden">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center gap-3">
                <div class="w-10 h-10 bg-ssia-green rounded-full flex items-center justify-center text-white font-bold">S</div>
                <span class="font-bold text-ssia-green text-lg">SSIA</span>
            </a>
            <a href="index.html" class="text-gray-600 hover:text-ssia-green font-medium flex items-center gap-2">
                <i class="fas fa-home"></i> Home
            </a>
        </div>
    </nav>

    <div id="loginScreen" class="flex-grow flex items-center justify-center bg-gray-100 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Admin Access</h2>
            <form onsubmit="checkLogin(event)">
                <input type="password" id="passcode" placeholder="Enter Passcode" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-ssia-green mb-4 text-center text-lg tracking-widest">
                <button type="submit" class="w-full bg-ssia-green text-white font-bold py-3 rounded-lg hover:bg-green-800 transition shadow-lg">Unlock Dashboard</button>
            </form>
            <p id="errorMsg" class="text-red-500 text-sm mt-3 hidden">Incorrect Passcode.</p>
        </div>
    </div>

    <div id="dashboard" class="hidden flex-grow">
        <div class="bg-white border-b sticky top-[72px] z-40 print:hidden">
            <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3"><div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 font-bold">A</div><h1 class="font-bold text-gray-700">Admin Console</h1></div>
                
                <div class="flex flex-wrap gap-2 text-xs md:text-sm font-bold justify-center">
                    <button onclick="switchTab('students')" id="nav-students" class="px-3 py-2 bg-green-50 text-ssia-green rounded border border-green-200">Admissions</button>
                    <button onclick="switchTab('teachers')" id="nav-teachers" class="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded border border-transparent">Teachers</button>
                    <button onclick="switchTab('academics')" id="nav-academics" class="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded border border-transparent">Records</button>
                    <button onclick="switchTab('processing')" id="nav-processing" class="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded border border-transparent">Results</button>
                    <button onclick="logout()" class="text-red-500 ml-2 px-2 hover:bg-red-50 rounded"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>

        <main class="container mx-auto px-4 py-8">
            
            <div id="section-students">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between"><h2 class="font-bold text-gray-800">Admission Applications</h2><button onclick="fetchAdmissions()" class="text-ssia-green font-bold text-sm">Refresh</button></div>
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm text-gray-600"><thead class="bg-gray-50 text-xs font-bold"><tr><th class="px-6 py-4">Student</th><th class="px-6 py-4">Grade</th><th class="px-6 py-4">Status</th><th class="px-6 py-4">Action</th></tr></thead><tbody id="studentTableBody"></tbody></table></div>
                </div>
            </div>

            <div id="section-teachers" class="hidden">
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h3 class="font-bold text-ssia-green mb-4">Assign Teacher</h3>
                        <form onsubmit="addTeacher(event)" class="space-y-4">
                            <input type="text" id="t_name" required placeholder="Full Name" class="w-full px-4 py-2 border rounded text-sm">
                            <input type="email" id="t_email" required placeholder="Email" class="w-full px-4 py-2 border rounded text-sm">
                            <input type="text" id="t_password" required placeholder="Password" class="w-full px-4 py-2 border rounded text-sm">
                            <select id="t_role" onchange="toggleSubjectField()" class="w-full px-4 py-2 border rounded bg-white text-sm"><option value="Class Teacher">Class Teacher</option><option value="Subject Teacher">Subject Teacher</option></select>
                            <div id="subjectField" class="hidden"><input type="text" id="t_subject_name" placeholder="Subject (e.g. Math)" class="w-full px-4 py-2 border rounded text-sm"></div>
                            <select id="t_target_class" required class="w-full px-4 py-2 border rounded bg-white text-sm">
                                <option value="">Select Class</option>
                                <optgroup label="Nursery"><option>Nursery 1</option><option>Nursery 2</option></optgroup>
                                <optgroup label="Primary"><option>Primary 1</option><option>Primary 2</option><option>Primary 3</option><option>Primary 4</option><option>Primary 5</option><option>Primary 6</option></optgroup>
                                <optgroup label="Secondary"><option>JSS 1</option><option>JSS 2</option><option>JSS 3</option><option>SSS 1</option><option>SSS 2</option><option>SSS 3</option></optgroup>
                            </select>
                            <button class="w-full bg-ssia-green text-white font-bold py-2 rounded">Create Account</button>
                        </form>
                    </div>
                    <div class="md:col-span-2 bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="p-6 border-b"><h2 class="font-bold">Staff List</h2></div>
                        <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-gray-50 font-bold"><tr><th class="px-6 py-4">Name</th><th class="px-6 py-4">Role</th><th class="px-6 py-4">Login</th><th class="px-6 py-4">Action</th></tr></thead><tbody id="teacherTableBody"></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="section-academics" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">View Records</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <select id="viewClass" onchange="updateSubjects()" class="flex-1 px-4 py-2 border rounded bg-white font-bold">
                            <option value="">Select Class</option>
                            <optgroup label="Nursery"><option>Nursery 1</option><option>Nursery 2</option></optgroup>
                            <optgroup label="Primary"><option>Primary 1</option><option>Primary 2</option><option>Primary 3</option><option>Primary 4</option><option>Primary 5</option><option>Primary 6</option></optgroup>
                            <optgroup label="Secondary"><option>JSS 1</option><option>JSS 2</option><option>JSS 3</option><option>SSS 1</option><option>SSS 2</option><option>SSS 3</option></optgroup>
                        </select>
                        <select id="viewSubject" class="flex-1 px-4 py-2 border rounded bg-white"><option value="">Select Class First</option></select>
                        <button onclick="fetchRecords()" class="bg-ssia-green text-white px-6 py-2 rounded font-bold">Load</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6 border-b bg-gray-50"><h3 class="font-bold text-gray-800" id="recordTitle">Records</h3></div>
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-gray-100 font-bold text-gray-500" id="recordHead"></thead><tbody id="recordBody"></tbody></table></div>
                </div>
            </div>

            <div id="section-processing" class="hidden">
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-4xl mx-auto border-t-4 border-blue-600">
                    <div class="text-center mb-8"><h2 class="text-2xl font-bold text-gray-800">Result Engine</h2><p class="text-gray-500">Compute positions and publish results.</p></div>
                    
                    <div class="flex gap-4 items-center mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <select id="processClass" onchange="checkClassStatus()" class="flex-1 px-4 py-3 border rounded bg-white font-bold">
                            <option value="">Select Class to Process</option>
                            <optgroup label="Nursery"><option>Nursery 1</option><option>Nursery 2</option></optgroup>
                            <optgroup label="Primary"><option>Primary 1</option><option>Primary 2</option><option>Primary 3</option><option>Primary 4</option><option>Primary 5</option><option>Primary 6</option></optgroup>
                            <optgroup label="Secondary"><option>JSS 1</option><option>JSS 2</option><option>JSS 3</option><option>SSS 1</option><option>SSS 2</option><option>SSS 3</option></optgroup>
                        </select>
                        <div id="statusIndicator" class="px-4 py-2 rounded bg-gray-200 text-gray-500 font-bold text-xs uppercase">WAITING</div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="border p-6 rounded-xl bg-blue-50 border-blue-100">
                            <h3 class="font-bold text-lg mb-2 text-blue-800">1. Compute</h3>
                            <button onclick="calculateResult()" id="btnCalc" class="bg-blue-600 text-white px-6 py-2 rounded font-bold w-full hover:bg-blue-700 disabled:opacity-50" disabled>Run Calculation</button>
                        </div>
                        <div class="border p-6 rounded-xl bg-green-50 border-green-100">
                            <h3 class="font-bold text-lg mb-2 text-green-800">2. Publish</h3>
                            <button onclick="openModal('Release')" id="btnRel" class="bg-green-600 text-white px-6 py-2 rounded font-bold w-full hover:bg-green-700 disabled:opacity-50" disabled>Release Results</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://rfrrqocpsiuyderbebtr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmcnJxb2Nwc2l1eWRlcmJlYnRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzkxNDgsImV4cCI6MjA4MTcxNTE0OH0.HGwjRIP0Y6Q8W8_Pzo2YnT6rpDRNtumjrFyi66hZULE';
        let adminClient;
        try { adminClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) {}

        // --- NAVIGATION ---
        function checkLogin(e) {
            e.preventDefault();
            if (document.getElementById('passcode').value === 'admin123') {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                fetchAdmissions();
            } else { document.getElementById('errorMsg').classList.remove('hidden'); }
        }
        function switchTab(tab) {
            ['students', 'teachers', 'academics', 'processing'].forEach(t => {
                document.getElementById(`section-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).className = "px-3 py-2 text-gray-600 hover:bg-gray-100 rounded border border-transparent";
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).className = "px-3 py-2 bg-green-50 text-ssia-green rounded border border-green-200 font-bold";
        }

        // --- CENTRAL MODAL SYSTEM ---
        function openModal(type, id, name) {
            const modal = document.getElementById('customModal');
            const iconBg = document.getElementById('modalIconBg');
            const icon = document.getElementById('modalIcon');
            const title = document.getElementById('modalTitle');
            const text = document.getElementById('modalText');
            const btn = document.getElementById('confirmBtn');

            modal.classList.remove('hidden');
            btn.disabled = false;
            btn.innerText = "Confirm";

            if (type === 'DeleteStudent') {
                title.innerText = "Delete Student?"; text.innerText = `Permanently delete ${name}?`;
                iconBg.className = "w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-red-600"; icon.className = "fas fa-trash";
                btn.className = "flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold shadow-md transition";
                btn.onclick = () => executeDeleteStudent(id);
            } else if (type === 'Approve') {
                title.innerText = "Approve Admission"; text.innerText = `Mark ${name} as Admitted?`;
                iconBg.className = "w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-green-600"; icon.className = "fas fa-check";
                btn.className = "flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold shadow-md transition";
                btn.onclick = () => executeStatus(id, 'Admitted');
            } else if (type === 'Reject') {
                title.innerText = "Decline Admission"; text.innerText = `Mark ${name} as Rejected?`;
                iconBg.className = "w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-red-600"; icon.className = "fas fa-times";
                btn.className = "flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold shadow-md transition";
                btn.onclick = () => executeStatus(id, 'Rejected');
            } else if (type === 'DeleteTeacher') {
                title.innerText = "Remove Teacher?"; text.innerText = `Revoke access?`;
                iconBg.className = "w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-gray-600"; icon.className = "fas fa-user-slash";
                btn.className = "flex-1 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-black font-bold shadow-md transition";
                btn.onclick = () => executeDeleteTeacher(id);
            } else if (type === 'Release') {
                const cls = document.getElementById('processClass').value;
                title.innerText = "Release Results?"; text.innerText = `Publish for ${cls}?`;
                iconBg.className = "w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl text-blue-600"; icon.className = "fas fa-globe";
                btn.className = "flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition";
                btn.onclick = () => executeRelease();
            }
        }

        function closeModal() { document.getElementById('customModal').classList.add('hidden'); }

        async function executeDeleteStudent(id) { closeModal(); const { error } = await adminClient.from('admissions').delete().eq('id', id); if(error) showToast(error.message, 'error'); else { showToast("Record deleted."); fetchAdmissions(); } }
        async function executeStatus(id, status) { closeModal(); const { error } = await adminClient.from('admissions').update({ status: status }).eq('id', id); if(error) showToast(error.message, 'error'); else { showToast(`Marked as ${status}`); fetchAdmissions(); } }
        async function executeDeleteTeacher(id) { closeModal(); const { error } = await adminClient.from('teachers').delete().eq('id', id); if(error) showToast(error.message, 'error'); else { showToast("Teacher removed."); fetchTeachers(); } }
        async function executeRelease() { closeModal(); const cls = document.getElementById('processClass').value; const { error } = await adminClient.from('class_status').update({ is_released: true }).eq('class_name', cls); if(error) showToast(error.message, 'error'); else { showToast("Results Released!"); checkClassStatus(); } }

        // --- FETCH LOGIC ---
        async function fetchAdmissions() {
            const { data } = await adminClient.from('admissions').select('*').order('created_at', { ascending: false });
            if(!data) return;
            document.getElementById('studentTableBody').innerHTML = data.map(s => {
                let color = s.status === 'Admitted' ? 'green' : (s.status === 'Rejected' ? 'red' : 'yellow');
                return `<tr class="border-b hover:bg-gray-50"><td class="px-6 py-4"><div class="font-bold">${s.full_name}</div><div class="text-xs text-gray-500">${s.admission_number || ''}</div></td><td class="px-6 py-4 text-xs font-bold uppercase text-gray-500">${s.grade_level}</td><td class="px-6 py-4"><span class="text-${color}-600 bg-${color}-100 px-2 py-1 rounded text-xs font-bold">${s.status || 'Pending'}</span></td><td class="px-6 py-4 flex gap-2"><button onclick="openModal('Approve', ${s.id}, '${s.full_name}')" class="text-green-500 hover:scale-110 text-lg"><i class="fas fa-check-circle"></i></button><button onclick="openModal('Reject', ${s.id}, '${s.full_name}')" class="text-red-500 hover:scale-110 text-lg"><i class="fas fa-times-circle"></i></button><button onclick="openModal('DeleteStudent', ${s.id}, '${s.full_name}')" class="text-gray-300 hover:text-black text-lg"><i class="fas fa-trash"></i></button></td></tr>`;
            }).join('');
        }

        // --- TEACHER LOGIC ---
        function toggleSubjectField() { document.getElementById('subjectField').classList.toggle('hidden', document.getElementById('t_role').value !== 'Subject Teacher'); }
        async function addTeacher(e) {
            e.preventDefault();
            const role = document.getElementById('t_role').value;
            const subject = role === 'Subject Teacher' ? document.getElementById('t_subject_name').value : '';
            const cls = document.getElementById('t_target_class').value;
            const assignment = role === 'Subject Teacher' ? `${subject} - ${cls}` : cls;
            const { error } = await adminClient.from('teachers').insert([{ full_name: document.getElementById('t_name').value, email: document.getElementById('t_email').value, password: document.getElementById('t_password').value, role: role, assigned_subject: assignment }]);
            if(error) showToast(error.message, 'error'); else { showToast("Teacher Added"); fetchTeachers(); e.target.reset(); }
        }
        async function fetchTeachers() {
            const { data } = await adminClient.from('teachers').select('*').order('created_at', { ascending: false });
            if(!data) return;
            document.getElementById('teacherTableBody').innerHTML = data.map(t => `<tr class="hover:bg-gray-50 border-b"><td class="px-6 py-4 font-bold text-gray-800">${t.full_name}</td><td class="px-6 py-4"><span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold uppercase">${t.role}</span><br><span class="text-xs text-ssia-green">${t.assigned_subject}</span></td><td class="px-6 py-4 text-xs font-mono text-gray-500">${t.email}<br>${t.password}</td><td class="px-6 py-4"><button onclick="openModal('DeleteTeacher', ${t.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        }

        // --- ACADEMIC VIEW LOGIC ---
        function updateSubjects() {
            const cls = document.getElementById('viewClass').value;
            const subSelect = document.getElementById('viewSubject');
            subSelect.innerHTML = '<option value="">Select Subject</option><option value="Attendance" class="font-bold text-ssia-green">>> VIEW ATTENDANCE <<</option><option disabled>--- Subjects ---</option>';
            let subjects = [];
            if (cls.includes('Nursery')) subjects = ["Numeracy", "Literacy", "Health Habits", "Social Habits", "Rhymes", "Creative Arts", "CRK/IRK"];
            else if (cls.includes('Primary')) subjects = ["Mathematics", "English Language", "Basic Science", "Social Studies", "Civic Education", "Agric Science", "Home Economics", "CRK/IRK", "Computer Studies"];
            else if (cls.includes('JSS')) subjects = ["Mathematics", "English Language", "Basic Science", "Basic Tech", "Business Studies", "Civic Education", "Social Studies", "Agric Science", "Home Economics", "Computer Studies", "CRK/IRK"];
            else if (cls.includes('SSS')) subjects = ["Mathematics", "English Language", "Biology", "Physics", "Chemistry", "Economics", "Government", "Geography", "Literature", "Agric Science", "Civic Education", "Marketing"];
            subjects.forEach(s => { let opt = document.createElement('option'); opt.value = s; opt.innerText = s; subSelect.add(opt); });
        }
        async function fetchRecords() {
            const cls = document.getElementById('viewClass').value;
            const sub = document.getElementById('viewSubject').value;
            const tbody = document.getElementById('recordBody');
            const thead = document.getElementById('recordHead');
            
            if(!cls || !sub) { showToast("Select Class & Subject", 'error'); return; }
            tbody.innerHTML = '<tr><td colspan="5" class="p-8 text-center">Loading...</td></tr>';
            
            if(sub === 'Attendance') {
                const { data } = await adminClient.from('attendance').select('*').eq('class', cls);
                thead.innerHTML = `<tr><th>Adm No</th><th>Present</th><th>Total</th><th>%</th></tr>`;
                tbody.innerHTML = data.map(r => `<tr><td class="p-4">${r.admission_number}</td><td class="p-4">${r.days_present}</td><td class="p-4">${r.days_opened}</td><td class="p-4">${Math.round((r.days_present/r.days_opened)*100)}%</td></tr>`).join('') || '<tr><td colspan="4" class="p-4 text-center">No data</td></tr>';
            } else {
                const { data } = await adminClient.from('grades').select('*').eq('class', cls).eq('subject', sub).order('total_score', {ascending: false});
                thead.innerHTML = `<tr><th>Student</th><th>CA</th><th>Exam</th><th>Total</th><th>Grade</th></tr>`;
                tbody.innerHTML = data.map(r => `<tr><td class="p-4">${r.student_name}</td><td class="p-4">${r.ca_score}</td><td class="p-4">${r.exam_score}</td><td class="p-4 font-bold">${r.total_score}</td><td class="p-4">${r.grade_letter || '-'}</td></tr>`).join('') || '<tr><td colspan="5" class="p-4 text-center">No scores</td></tr>';
            }
        }

        // --- RESULT LOGIC ---
        async function checkClassStatus() {
            const cls = document.getElementById('processClass').value;
            if(!cls) return;
            const { data } = await adminClient.from('class_status').select('*').eq('class_name', cls);
            let isCalc = false, isRel = false;
            if(data && data.length > 0) { isCalc = data[0].is_calculated; isRel = data[0].is_released; }
            else { await adminClient.from('class_status').insert([{ class_name: cls }]); }
            document.getElementById('btnCalc').disabled = false;
            if(isCalc) document.getElementById('btnRel').disabled = false;
            const ind = document.getElementById('statusIndicator');
            if(isRel) { ind.innerText = "RELEASED"; ind.className = "px-4 py-2 rounded bg-green-100 text-green-700 font-bold text-xs"; }
            else if(isCalc) { ind.innerText = "CALCULATED"; ind.className = "px-4 py-2 rounded bg-blue-100 text-blue-700 font-bold text-xs"; }
            else { ind.innerText = "PENDING"; ind.className = "px-4 py-2 rounded bg-yellow-100 text-yellow-700 font-bold text-xs"; }
        }
        async function calculateResult() {
            const cls = document.getElementById('processClass').value;
            const { data: grades } = await adminClient.from('grades').select('*').eq('class', cls);
            if(!grades || grades.length === 0) { showToast("No scores to process", 'error'); return; }
            const subjects = [...new Set(grades.map(i => i.subject))];
            for (let sub of subjects) {
                let subScores = grades.filter(g => g.subject === sub).sort((a,b) => b.total_score - a.total_score);
                for(let i=0; i<subScores.length; i++) {
                    let score = subScores[i].total_score;
                    let grade = score >= 70 ? 'A' : (score >= 60 ? 'B' : (score >= 50 ? 'C' : (score >= 40 ? 'D' : 'F')));
                    await adminClient.from('grades').update({ position: i+1, grade_letter: grade }).eq('id', subScores[i].id);
                }
            }
            await adminClient.from('class_status').update({ is_calculated: true }).eq('class_name', cls);
            showToast("Calculated!"); checkClassStatus();
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            if(type==='error'){ t.classList.replace('border-ssia-green','border-red-500'); document.getElementById('toastIcon').className='fas fa-times'; document.getElementById('toastIconBg').className='bg-red-100 p-2 rounded-full text-red-600'; document.getElementById('toastTitle').innerText="Error"; }
            else { t.classList.replace('border-red-500','border-ssia-green'); document.getElementById('toastIcon').className='fas fa-check'; document.getElementById('toastIconBg').className='bg-green-100 p-2 rounded-full text-green-600'; document.getElementById('toastTitle').innerText="Success"; }
            t.classList.remove('translate-x-[150%]'); setTimeout(() => t.classList.add('translate-x-[150%]'), 3000);
        }
        function logout() { location.reload(); }
    </script>
</body>
</html>
